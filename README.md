# Gate Pay Android SDK Integration Guide

## 1. Obtain the SDK Package and Add Dependencies

### 1.1 Obtain the `repos` folder from Gate and integrate it into the project root directory, or import it into your local Maven repository.

### 1.2 Add the local Maven repository path in the project-level `build.gradle`.

```gradle
allprojects {
    repositories {
        maven {
            url uri("${rootProject.projectDir}/repos")
        }
    }
}
```

### 1.3 Add the SDK dependency in the app module's `build.gradle` under `dependencies`.

```gradle
implementation 'com.gateio.sdk:gatepay-sdk:1.0.0'
```

---

## 2. Configure the Scheme in AndroidManifest (for Callback)

Configure the Scheme in the corresponding Activity that initiates the payment in AndroidManifest:

```xml
<intent-filter>
  <data
      android:host="payment"
      android:scheme="gatepay******" />
  <action android:name="android.intent.action.VIEW" />

  <category android:name="android.intent.category.DEFAULT" />
  <category android:name="android.intent.category.BROWSABLE" />
</intent-filter>
```

> üí° **Tip:** If you cannot find the provided Scheme, you can call `GatePaySDK.getSchemeByClientId()` and pass in the `clientId` to retrieve it.

---

## 3. Initialize the SDK in Application's onCreate

**Method: GatePaySDK.init()**

```kotlin
fun init(isDebug: Boolean, context: Context, clientId: String)
```

**Example Call:**

```kotlin
class App : Application() {
    override fun onCreate() {
        super.onCreate()
        GatePaySDK.init(
            isDebug = BuildConfig.DEBUG,
            context = this,
            clientId = "your_client_id"
        )
    }
}
```

### Parameter Description

| Parameter | Type | Description |
|------|------|------|
| `isDebug` | Boolean | Whether to enable debug mode (**‚ö†Ô∏è must be set to false in production**).<br>Logs can be filtered using the tag `"gate_pay_sdk"` to view detailed error messages. |
| `context` | Context | It is recommended to pass the Application Context. |
| `clientId` | String | The clientId obtained from the Gate Pay platform (i.e., the `api_key` provided by Gate). |

> ‚ö†Ô∏è **Important:** None of the parameters can be null, otherwise initialization will fail.

---

## 4. Launch the Payment Component

After obtaining the **prepay order ID** and **signature information** from your server, invoke the Gate Pay payment component using `GatePaySDK.startGatePay()`.

**Method: GatePaySDK.startGatePay()**

```kotlin
fun startGatePay(
    activity: Activity,
    signature: String,
    timesTamp: String,
    nonce: String,
    prepayId: String,
    packageExt: String,
    navigationGatePayListener: NavigationGatePayListener
)
```

**Example Call:**

```kotlin
GatePaySDK.startGatePay(
    activity = this,
    signature = bizData.signature,
    timesTamp = bizData.ts,
    nonce = bizData.nonce,
    prepayId = bizData.prepayId,
    packageExt = "GatePay",
    navigationGatePayListener = object : NavigationGatePayListener {
        override fun onGateOpenSuccess() {
            Log.i("gate_pay_sdk", "onGateOpenSuccess()")
        }
        
        override fun onGateOpenFailed(code: Int, errorMessage: String?) {
            Log.i("gate_pay_sdk", "onGateOpenFailed: code=$code, message=$errorMessage")
        }
    }
)
```

> ‚ö†Ô∏è **Security Compliance:** All signature-related parameters (signature, timesTamp, nonce, prepayId) must be generated and issued by the server. The client only forwards these parameters and must not participate in the signature calculation. Reconciliation is based on the server's asynchronous notification.

> üìñ **Server Integration:** For details on how to generate signatures and integrate APIs on the server side, please refer to the [Gate Pay Server Documentation](https://www.gate.com/docs/gatepay/common/en/).

### Parameter Description

| Parameter | Type | Description |
|------|------|------|
| `activity` | Activity | The current Activity instance |
| `signature` | String | **(Generated by server)** Request signature used by Gate Pay to verify request validity. |
| `timesTamp` | String | **(Generated by server)** UTC timestamp at the time the request is created, in milliseconds.<br>‚ö†Ô∏è Requests with a time difference greater than 5 seconds will be rejected. |
| `nonce` | String | **(Generated by server)** Random string that complies with HTTP Header specifications.<br>Recommended length: within 32 characters, consisting of letters and numbers only. |
| `prepayId` | String | **(Returned by server)** The obtained prepay order ID. |
| `packageExt` | String | Extension field. Fixed value: `"GatePay"`. |
| `navigationGatePayListener` | NavigationGatePayListener | Callback listener for success or failure when launching the component. |

### Error Code Reference

**Callback Methods:**

```kotlin
fun onGateOpenFailed(code: Int, errorMessage: String?)
```

| Code | Error Message | Description |
|------|---------------|------|
| 10021 | openPackage failed | Please check whether the app has permission to launch external applications. |
| 10022 | intentData error | Please check whether prepayId and redirectUri are correct. |
| 10023 | response data is null | Please verify whether the signature parameters are correct. |
| 10023 | throwable.getMessage() | Please check the exception message returned by onGateOpenFailed for troubleshooting. |
| 10024 | params error | Please check whether the initialization or payment invocation parameters are correct. |

> ‚ÑπÔ∏è **Note:** For error codes not listed above, please refer directly to the returned errorMessage, or check the corresponding Gate Pay server-side error codes.

---

## 5. Payment Result Callback

The callback result is obtained through the Activity configured with the Scheme.

**Callback Format:**

```
{scheme}://{host}?isSuccess={code}&source=gatePay&prepayId={prepayId}
```

**Example:**

```
gatepay******://payment?isSuccess=1&source=gatePay&prepayId=123435567
```

### Parameter Description

| Parameter | Value | Description |
|------|-----|------|
| `scheme` | gatepay****** | The Scheme generated by Gate |
| `host` | payment | Fixed value |
| `isSuccess` | `1` | Success (`GatePayConstant.PAYMENT_STATE_SUCCESS_CODE`) |
|  | `0` | Failed (`GatePayConstant.PAYMENT_STATE_FAILED_CODE`) |
|  | `2` | Canceled (`GatePayConstant.PAYMENT_STATE_CANCEL_CODE`) |
| `source` | gatePay | Fixed value |
| `prepayId` | - | Prepay order ID |

---

## 6. Android FAQs

### 6.1 Unable to return to the current app after configuring the Scheme?

Please check the configuration of the current Activity in AndroidManifest:

- Whether `android:exported="true"` is set
- Whether the following code is configured:

```xml
<data
    android:host="payment"
    android:scheme="gatepay******" />
```

> üí° Note: Make sure that gatepay****** matches your actual Scheme.
> üí° **Recommendation:** Set the launch mode to `android:launchMode="singleTask"`

---

### 6.2 No response after calling startGatePay?

Set `isDebug` to `true` during initialization and filter logs in Logcat using the keyword `"gate_pay_sdk"` to view the corresponding error messages.

**Possible causes include, but are not limited to:**

1. The SDK has not been initialized
2. clientId is not configured
3. The Gate App is not installed (the SDK will automatically redirect to the download page)
4. The Gate App has not been upgraded to the latest version [6.34.0+] (the SDK will display a prompt for update and download)

---

### 6.3 Unable to obtain the payment result callback status?

Refer to Section 5 and check the following:

- Whether the current app restricts interaction with other apps
- Whether the parameters match the Scheme provided by Gate
- The Scheme is tightly bound to the clientId
- Whether the required permissions are correctly configured

---

### 6.4 Why must the payment signature be obtained from the server when initiating a payment?

After the platform information is registered, Gate Pay will issue the `api_key` and `api_secret` to the third party:

- `api_key` as the identity identifier
- `api_secret` for request signature generation

> ‚ö†Ô∏è **Important:** The `api_secret` must be securely stored to prevent unauthorized access, and all signatures must be generated exclusively on the server.

> üìù **Note:** You may refer to GatePayDemo for the complete integration workflow.

---

### 6.5 Is integration supported for non-app applications (e.g., H5 web pages)?

For H5-based payments, you can directly integrate the Gate Pay Web Checkout, which already handles the redirection logic internally.

> ‚ö†Ô∏è **Note:** Same as app-based payments, only Gate App versions [6.34.0+] or later are supported.

**Supported Scheme redirections include:**

```
gatepay://miniapp/gatepay?prepayId=1234567
```
